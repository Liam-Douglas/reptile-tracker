{% extends "base.html" %}

{% block title %}My Reptiles - Reptile Tracker{% endblock %}

{% block content %}
    <!-- Alert Banner -->
    <!-- DEBUG: total_alerts = {{ total_alerts }} -->
    {% if total_alerts > 0 %}
    <div id="alertBanner" class="alert-banner">
        <div class="alert-banner-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span><strong>{{ total_alerts }}</strong> Alert{{ 's' if total_alerts != 1 else '' }}</span>
        </div>
        <button onclick="showAlertModal()" class="alert-banner-btn">
            View Details <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    {% endif %}

    <!-- Alert Modal -->
    <div id="alertModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Alerts & Notifications</h3>
                <button class="modal-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Overdue Feedings -->
                {% if overdue_feedings %}
                <div class="alert-section">
                    <h4 class="alert-section-title">
                        <i class="fas fa-utensils"></i> Overdue Feedings ({{ overdue_feedings|length }})
                    </h4>
                    <div class="alert-items">
                        {% for feeding in overdue_feedings %}
                        <a href="{{ url_for('reptile_details', reptile_id=feeding.reptile_id) }}" class="alert-item">
                            <div class="alert-item-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="alert-item-content">
                                <div class="alert-item-title">{{ feeding.reptile_name }}</div>
                                <div class="alert-item-subtitle">
                                    Due: {{ feeding.next_feeding_date|format_date }}
                                    {% if feeding.days_overdue %}
                                        ({{ feeding.days_overdue }} day{{ 's' if feeding.days_overdue != 1 else '' }} overdue)
                                    {% endif %}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #9ca3af;"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Out of Stock Items -->
                {% if out_of_stock %}
                <div class="alert-section">
                    <h4 class="alert-section-title">
                        <i class="fas fa-times-circle"></i> Out of Stock ({{ out_of_stock|length }})
                    </h4>
                    <div class="alert-items">
                        {% for item in out_of_stock %}
                        <a href="{{ url_for('finance') }}" class="alert-item">
                            <div class="alert-item-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="alert-item-content">
                                <div class="alert-item-title">{{ item.food_type }}</div>
                                <div class="alert-item-subtitle">
                                    {% if item.food_size %}{{ item.food_size }} - {% endif %}Out of stock
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #9ca3af;"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Low Stock Items -->
                {% if low_stock %}
                <div class="alert-section">
                    <h4 class="alert-section-title">
                        <i class="fas fa-exclamation-circle"></i> Low Stock ({{ low_stock|length }})
                    </h4>
                    <div class="alert-items">
                        {% for item in low_stock %}
                        <a href="{{ url_for('finance') }}" class="alert-item">
                            <div class="alert-item-icon" style="background: linear-gradient(135deg, #ffa726, #fb8c00);">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="alert-item-content">
                                <div class="alert-item-title">{{ item.food_type }}</div>
                                <div class="alert-item-subtitle">
                                    {% if item.food_size %}{{ item.food_size }} - {% endif %}{{ item.quantity }} remaining
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #9ca3af;"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if not overdue_feedings and not low_stock and not out_of_stock %}
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.1rem; margin: 0;">All clear! No alerts at this time.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

<div class="reptiles-page-modern">
    <!-- Modern Header -->
    <div class="modern-header">
        <div class="header-content">
            <div>
                <h1 class="header-title">
                    <i class="fas fa-dragon"></i> My Reptiles
                </h1>
                <p class="header-subtitle">Manage your collection, records, and reminders</p>
            </div>
            <div class="header-actions">
                <div class="header-stats-mini">
                    <div class="mini-stat">
                        <div class="mini-stat-value">{{ reptiles|length }}</div>
                        <div class="mini-stat-label">Total Reptiles</div>
                    </div>
                </div>
                <a href="{{ url_for('add_reptile') }}" class="btn-modern btn-primary">
                    <i class="fas fa-plus"></i> Add Reptile
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="reptiles-tabs">
        <button class="reptiles-tab active" onclick="switchReptileTab('collection')">
            <i class="fas fa-th-large"></i> Collection
        </button>
        <button class="reptiles-tab" onclick="switchReptileTab('records')">
            <i class="fas fa-clipboard-list"></i> Records
        </button>
        <button class="reptiles-tab" onclick="switchReptileTab('reminders')">
            <i class="fas fa-bell"></i> Reminders
        </button>
    </div>

    <!-- Collection Tab -->
    <div id="collection-tab" class="reptiles-tab-content active">
        {% if reptiles %}
            <div class="reptiles-grid-modern">
                {% for reptile in reptiles %}
                <div class="reptile-card-detailed">
                    <!-- Card Image -->
                    <div class="card-image-wrapper">
                        {% if reptile.image_path %}
                            <img src="{{ url_for('uploaded_file', filename=reptile.image_path) }}" alt="{{ reptile.name }}" class="card-img">
                        {% else %}
                            <div class="card-img-placeholder">
                                <i class="fas fa-dragon"></i>
                            </div>
                        {% endif %}
                        <div class="card-overlay">
                            <a href="{{ url_for('reptile_details', reptile_id=reptile.id) }}" class="view-details-btn">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>

                    <!-- Card Content -->
                    <div class="card-body-detailed">
                        <!-- Name, Age, and Sex -->
                        <div class="card-header-row">
                            <h3 class="card-name">
                                {{ reptile.name }}
                                {% if reptile.date_of_birth %}
                                    <span style="font-size: 0.7em; font-weight: normal; color: #6b7280; margin-left: 0.5rem;">
                                        ({{ reptile.date_of_birth|calculate_age }})
                                    </span>
                                {% endif %}
                            </h3>
                            {% if reptile.sex %}
                                {% if reptile.sex == 'Male' %}
                                    <span class="sex-icon male"><i class="fas fa-mars"></i></span>
                                {% elif reptile.sex == 'Female' %}
                                    <span class="sex-icon female"><i class="fas fa-venus"></i></span>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Species -->
                        <div class="card-species">
                            <i class="fas fa-dragon"></i> {{ reptile.species }}
                        </div>

                        <!-- Morph Badge -->
                        {% if reptile.morph %}
                            <div class="morph-badge-wrapper">
                                <span class="morph-badge">
                                    <i class="fas fa-palette"></i> {{ reptile.morph }}
                                </span>
                            </div>
                        {% endif %}

                        <!-- Feeding Status -->
                        {% if reptile.last_feeding_date %}
                            {% set days_text = reptile.last_feeding_date|days_ago %}
                            {% if days_text == 'Today' %}
                                <div class="feeding-status-bar fed-today">
                                    <i class="fas fa-utensils"></i> Fed {{ days_text|lower }}
                                </div>
                            {% elif 'day ago' in days_text or 'days ago' in days_text %}
                                {% set days_num = days_text.split()[0]|int if days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 3 %}
                                    <div class="feeding-status-bar fed-recent">
                                        <i class="fas fa-utensils"></i> Fed {{ days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar fed-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Fed {{ days_text|lower }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="feeding-status-bar no-data">
                                    <i class="fas fa-info-circle"></i> No feeding recorded
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No feeding recorded
                            </div>
                        {% endif %}

                        <!-- Next Feeding Date (right after feeding status) -->
                        {% if reptile.next_feeding_date %}
                            {% set next_days_text = reptile.next_feeding_date|days_until %}
                            {% if next_days_text == 'Today' %}
                                <div class="feeding-status-bar next-feeding-today">
                                    <i class="fas fa-calendar-check"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% elif 'in' in next_days_text %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% elif 'day' in next_days_text or 'days' in next_days_text %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% else %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next feeding: {{ reptile.next_feeding_date|format_date }}
                                </div>
                            {% endif %}
                        {% endif %}

                        <!-- Tank Last Cleaned -->
                        {% if reptile.last_tank_cleaning_date %}
                            {% set cleaning_days_text = reptile.last_tank_cleaning_date|days_ago %}
                            {% if cleaning_days_text == 'Today' %}
                                <div class="feeding-status-bar tank-cleaned-today">
                                    <i class="fas fa-spray-can"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                </div>
                            {% elif 'day ago' in cleaning_days_text or 'days ago' in cleaning_days_text %}
                                {% set days_num = cleaning_days_text.split()[0]|int if cleaning_days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 7 %}
                                    <div class="feeding-status-bar tank-cleaned-recent">
                                        <i class="fas fa-spray-can"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar tank-cleaned-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No tank cleaning recorded
                            </div>
                        {% endif %}

                        <!-- Last Handled -->
                        {% if reptile.last_handling_date %}
                            {% set handling_days_text = reptile.last_handling_date|days_ago %}
                            {% if handling_days_text == 'Today' %}
                                <div class="feeding-status-bar handled-today">
                                    <i class="fas fa-hand-holding"></i> Handled {{ handling_days_text|lower }}
                                </div>
                            {% elif 'day ago' in handling_days_text or 'days ago' in handling_days_text %}
                                {% set days_num = handling_days_text.split()[0]|int if handling_days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 7 %}
                                    <div class="feeding-status-bar handled-recent">
                                        <i class="fas fa-hand-holding"></i> Handled {{ handling_days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar handled-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Handled {{ handling_days_text|lower }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No handling recorded
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state-large">
                <i class="fas fa-dragon"></i>
                <h3>No Reptiles Yet</h3>
                <p>Add your first reptile to start tracking their care</p>
                <a href="{{ url_for('add_reptile') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Your First Reptile
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Records Tab -->
    <div id="records-tab" class="reptiles-tab-content">
        <div class="records-container">
            <!-- Quick Actions -->
            <div class="quick-actions-bar">
                <button onclick="showLogActivityModal()" class="action-btn primary">
                    <i class="fas fa-plus"></i> Log Activity
                </button>
            </div>

            <!-- Log Activity Modal -->
            <div id="logActivityModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 id="modalTitle"><i class="fas fa-clipboard-list"></i> What would you like to log?</h3>
                        <button class="modal-close" onclick="closeLogActivityModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Activity Selection View -->
                        <div id="activitySelection" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <a href="#" onclick="event.preventDefault(); showReptileSelector('feeding');" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <h4>Feeding</h4>
                                <p>Log a feeding session</p>
                            </a>
                            <a href="#" onclick="event.preventDefault(); showReptileSelector('shed');" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <h4>Shed</h4>
                                <p>Record a shed event</p>
                            </a>
                            <a href="#" onclick="event.preventDefault(); showReptileSelector('cleaning');" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                                    <i class="fas fa-spray-can"></i>
                                </div>
                                <h4>Tank Cleaning</h4>
                                <p>Log tank maintenance</p>
                            </a>
                            <a href="#" onclick="event.preventDefault(); showReptileSelector('handling');" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                                    <i class="fas fa-hand-holding"></i>
                                </div>
                                <h4>Handling</h4>
                                <p>Record handling session</p>
                            </a>
                        </div>

                        <!-- Reptile Selection View -->
                        <div id="reptileSelection" style="display: none;">
                            <button onclick="backToActivitySelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <div style="display: grid; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
                                {% for reptile in reptiles %}
                                <a href="#" onclick="event.preventDefault(); selectReptile({{ reptile.id }})" class="reptile-selector-card">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        {% if reptile.image_path %}
                                            <img src="{{ url_for('uploaded_file', filename=reptile.image_path) }}"
                                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white;">
                                                <i class="fas fa-dragon"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <div style="font-weight: 600; font-size: 1.05rem;">{{ reptile.name }}</div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ reptile.species }}</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Form View -->
                        <div id="formView" style="display: none;">
                            <button onclick="backToReptileSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <div id="formContainer">
                                <!-- Form will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Grid -->
            <div class="records-grid-modern">
                <!-- Feeding Logs -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-utensils"></i> Recent Feedings</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ feeding_logs|length }} records</span>
                            <a href="{{ url_for('feeding_logs') }}" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if feeding_logs %}
                            <div class="records-list-modern">
                                {% for log in feeding_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle feeding">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">{{ log.food_type }}{% if log.food_size %} ({{ log.food_size }}){% endif %}</div>
                                        <div class="record-date">{{ log.feeding_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        {% if log.ate %}
                                            <span class="badge-success"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge-danger"><i class="fas fa-times"></i></span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-utensils"></i>
                                <p>No feeding records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Shed Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-sync-alt"></i> Recent Sheds</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ shed_records|length }} records</span>
                            <a href="{{ url_for('shed_records') }}" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if shed_records %}
                            <div class="records-list-modern">
                                {% for record in shed_records[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle shed">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ record.reptile_name }}</div>
                                        <div class="record-details">Shed Record</div>
                                        <div class="record-date">{{ record.shed_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        {% if record.complete %}
                                            <span class="badge-success"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge-warning"><i class="fas fa-exclamation"></i></span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-sync-alt"></i>
                                <p>No shed records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tank Cleaning Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-spray-can"></i> Recent Tank Cleanings</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ tank_cleaning_logs|length }} records</span>
                            <a href="{{ url_for('records_page') }}#tank-cleaning" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if tank_cleaning_logs %}
                            <div class="records-list-modern">
                                {% for log in tank_cleaning_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle" style="background: linear-gradient(135deg, #99f6e4, #5eead4);">
                                        <i class="fas fa-spray-can"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">{{ log.cleaning_type }}</div>
                                        <div class="record-date">{{ log.cleaning_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        <span class="badge-success"><i class="fas fa-check"></i></span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-spray-can"></i>
                                <p>No tank cleaning records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Handling Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-hand-holding"></i> Recent Handling</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ handling_logs|length }} records</span>
                            <a href="{{ url_for('records_page') }}#handling" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if handling_logs %}
                            <div class="records-list-modern">
                                {% for log in handling_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle" style="background: linear-gradient(135deg, #f9a8d4, #f472b6);">
                                        <i class="fas fa-hand-holding"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">
                                            {% if log.duration_minutes %}{{ log.duration_minutes }} min{% endif %}
                                            {% if log.behavior %} â€¢ {{ log.behavior }}{% endif %}
                                        </div>
                                        <div class="record-date">{{ log.handling_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        <span class="badge-success"><i class="fas fa-check"></i></span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-hand-holding"></i>
                                <p>No handling records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminders Tab -->
    <div id="reminders-tab" class="reptiles-tab-content">
        <div class="reminders-container">
            <!-- Quick Actions -->
            <div class="quick-actions-bar">
                <a href="{{ url_for('feeding_reminders') }}" class="action-btn primary">
                    <i class="fas fa-plus"></i> Set New Reminder
                </a>
                <a href="{{ url_for('feeding_reminders') }}" class="action-btn outline">
                    <i class="fas fa-cog"></i> Manage All Reminders
                </a>
            </div>

            <!-- Alerts -->
            {% if overdue_feedings %}
            <div class="alert-card danger">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h3>Overdue Feedings ({{ overdue_feedings|length }})</h3>
                    <ul class="alert-list">
                        {% for feeding in overdue_feedings %}
                        <li>
                            <strong>{{ feeding.reptile_name }}</strong> - Last fed {{ feeding.last_feeding_date|format_date }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {% if upcoming_feedings %}
            <div class="alert-card info">
                <div class="alert-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="alert-content">
                    <h3>Upcoming Feedings ({{ upcoming_feedings|length }})</h3>
                    <ul class="alert-list">
                        {% for feeding in upcoming_feedings %}
                        <li>
                            <strong>{{ feeding.reptile_name }}</strong> - Due {{ feeding.next_feeding_date|format_date }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Active Reminders -->
            <div class="reminders-section-card">
                <div class="section-card-header">
                    <h3><i class="fas fa-bell"></i> Active Reminders</h3>
                    <span class="count-badge">{{ reminders|length if reminders else 0 }} active</span>
                </div>
                <div class="section-card-body">
                    {% if reminders %}
                        <div class="reminders-list-modern">
                            {% for reminder in reminders %}
                            <div class="reminder-row">
                                <div class="reminder-icon-circle">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="reminder-info">
                                    <div class="reminder-name">{{ reminder.reptile_name }}</div>
                                    <div class="reminder-schedule">Every {{ reminder.frequency_days }} days</div>
                                </div>
                                <div class="reminder-actions">
                                    <div class="reminder-status">
                                        {% if reminder.enabled %}
                                            <span class="status-active"><i class="fas fa-check-circle"></i> Active</span>
                                        {% else %}
                                            <span class="status-paused"><i class="fas fa-pause-circle"></i> Paused</span>
                                        {% endif %}
                                    </div>
                                    <a href="{{ url_for('set_feeding_reminder', reptile_id=reminder.reptile_id) }}" class="edit-reminder-btn">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state-small">
                            <i class="fas fa-bell-slash"></i>
                            <p>No active reminders</p>
                            <a href="{{ url_for('feeding_reminders') }}" class="btn btn-secondary" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Set Your First Reminder
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--bg-primary);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
}

.log-option-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.log-option-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.log-option-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: white;
    font-size: 1.5rem;
}

.log-option-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.log-option-card p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
}

.reptile-selector-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.reptile-selector-card:hover {
    background: var(--bg-light);
    border-color: var(--primary-color);
    transform: translateX(4px);
}
</style>

<script>
function switchReptileTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.reptiles-tab-content');
    tabContents.forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    const tabs = document.querySelectorAll('.reptiles-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked tab
    event.target.closest('.reptiles-tab').classList.add('active');
}

let selectedActivityType = '';
let selectedReptileId = null;
let currentFormData = null;

function showLogActivityModal() {
    document.getElementById('logActivityModal').style.display = 'flex';
    backToActivitySelection();
}

function closeLogActivityModal() {
    document.getElementById('logActivityModal').style.display = 'none';
    backToActivitySelection();
}

function showReptileSelector(activityType) {
    selectedActivityType = activityType;
    document.getElementById('activitySelection').style.display = 'none';
    document.getElementById('reptileSelection').style.display = 'block';
    
    const titles = {
        'feeding': 'Feeding',
        'shed': 'Shed',
        'cleaning': 'Tank Cleaning',
        'handling': 'Handling'
    };
    const icons = {
        'feeding': 'utensils',
        'shed': 'sync-alt',
        'cleaning': 'spray-can',
        'handling': 'hand-holding'
    };
    
    document.getElementById('modalTitle').innerHTML = `<i class="fas fa-${icons[activityType]}"></i> Select Reptile for ${titles[activityType]}`;
}

function backToActivitySelection() {
    document.getElementById('activitySelection').style.display = 'grid';
    document.getElementById('reptileSelection').style.display = 'none';
    document.getElementById('formView').style.display = 'none';
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-clipboard-list"></i> What would you like to log?';
    selectedActivityType = '';
    selectedReptileId = null;
}

function backToReptileSelection() {
    document.getElementById('reptileSelection').style.display = 'block';
    document.getElementById('formView').style.display = 'none';
    showReptileSelector(selectedActivityType);
}

async function selectReptile(reptileId) {
    selectedReptileId = reptileId;
    
    // Show loading
    document.getElementById('reptileSelection').style.display = 'none';
    document.getElementById('formView').style.display = 'block';
    document.getElementById('formContainer').innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i><p style="margin-top: 1rem;">Loading form...</p></div>';
    
    try {
        // Fetch form data from API
        const response = await fetch(`/api/${selectedActivityType === 'cleaning' ? 'tank-cleaning' : selectedActivityType}-form/${reptileId}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentFormData = data;
        
        // Update modal title
        const titles = {
            'feeding': 'Log Feeding',
            'shed': 'Log Shed',
            'cleaning': 'Log Tank Cleaning',
            'handling': 'Log Handling'
        };
        document.getElementById('modalTitle').innerHTML = `<i class="fas fa-clipboard-list"></i> ${titles[selectedActivityType]} - ${data.reptile.name}`;
        
        // Render the appropriate form
        renderForm(selectedActivityType, data);
    } catch (error) {
        document.getElementById('formContainer').innerHTML = `<div style="text-align: center; padding: 2rem; color: #f44336;"><i class="fas fa-exclamation-circle" style="font-size: 2rem;"></i><p style="margin-top: 1rem;">Error loading form: ${error.message}</p></div>`;
    }
}

function renderForm(activityType, data) {
    let formHTML = '';
    
    if (activityType === 'feeding') {
        formHTML = renderFeedingForm(data);
    } else if (activityType === 'shed') {
        formHTML = renderShedForm(data);
    } else if (activityType === 'cleaning') {
        formHTML = renderTankCleaningForm(data);
    } else if (activityType === 'handling') {
        formHTML = renderHandlingForm(data);
    }
    
    document.getElementById('formContainer').innerHTML = formHTML;
}

function renderFeedingForm(data) {
    return `
        <form id="activityForm" onsubmit="submitForm(event)" style="display: grid; gap: 1rem;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Date</label>
                <input type="date" name="date" value="${data.today}" required
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Food Type</label>
                <input type="text" name="food_type" required list="food-types"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                <datalist id="food-types">
                    ${data.food_types.map(type => `<option value="${type}">`).join('')}
                </datalist>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Food Size</label>
                <input type="text" name="food_size" list="food-sizes"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                <datalist id="food-sizes">
                    ${data.food_sizes.map(size => `<option value="${size}">`).join('')}
                </datalist>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Quantity</label>
                <input type="number" name="quantity" value="1" min="1" required
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Did they eat?</label>
                <select name="ate" required
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Notes (Optional)</label>
                <textarea name="notes" rows="3"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Log Feeding
                </button>
                <button type="button" onclick="backToReptileSelection()" class="btn btn-secondary" style="padding: 0.875rem;">
                    Cancel
                </button>
            </div>
        </form>
    `;
}

function renderShedForm(data) {
    return `
        <form id="activityForm" onsubmit="submitForm(event)" style="display: grid; gap: 1rem;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Date</label>
                <input type="date" name="date" value="${data.today}" required
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Was the shed complete?</label>
                <select name="complete" required
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    <option value="yes">Yes - Complete</option>
                    <option value="no">No - Partial/Stuck Shed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Shed Length (cm) - Optional</label>
                <input type="number" name="shed_length_cm" step="0.1" min="0"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Notes (Optional)</label>
                <textarea name="notes" rows="3"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Log Shed
                </button>
                <button type="button" onclick="backToReptileSelection()" class="btn btn-secondary" style="padding: 0.875rem;">
                    Cancel
                </button>
            </div>
        </form>
    `;
}

function renderTankCleaningForm(data) {
    return `
        <form id="activityForm" onsubmit="submitForm(event)" style="display: grid; gap: 1rem;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Date</label>
                <input type="date" name="cleaning_date" value="${data.today}" required
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Cleaning Type</label>
                <select name="cleaning_type" required
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    <option value="">Select cleaning type...</option>
                    <option value="Spot Clean">Spot Clean</option>
                    <option value="Partial Clean">Partial Clean</option>
                    <option value="Deep Clean">Deep Clean</option>
                    <option value="Full Substrate Change">Full Substrate Change</option>
                    <option value="Disinfection">Disinfection</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Notes (Optional)</label>
                <textarea name="notes" rows="3"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Log Cleaning
                </button>
                <button type="button" onclick="backToReptileSelection()" class="btn btn-secondary" style="padding: 0.875rem;">
                    Cancel
                </button>
            </div>
        </form>
    `;
}

function renderHandlingForm(data) {
    return `
        <form id="activityForm" onsubmit="submitForm(event)" style="display: grid; gap: 1rem;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Date</label>
                <input type="date" name="handling_date" value="${data.today}" required
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Duration (minutes) - Optional</label>
                <input type="number" name="duration_minutes" min="1"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Behavior - Optional</label>
                <select name="behavior"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    <option value="">Select behavior...</option>
                    <option value="Calm">Calm</option>
                    <option value="Active">Active</option>
                    <option value="Defensive">Defensive</option>
                    <option value="Stressed">Stressed</option>
                    <option value="Curious">Curious</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Notes (Optional)</label>
                <textarea name="notes" rows="3"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Log Handling
                </button>
                <button type="button" onclick="backToReptileSelection()" class="btn btn-secondary" style="padding: 0.875rem;">
                    Cancel
                </button>
            </div>
        </form>
    `;
}

async function submitForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Add use_inventory flag for feeding
    if (selectedActivityType === 'feeding') {
        data.use_inventory = 'no';
    }
    
    // Disable submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        const endpoint = selectedActivityType === 'cleaning' ? 'tank-cleaning' : selectedActivityType;
        const response = await fetch(`/api/${endpoint}/${selectedReptileId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Show success message
        alert(result.message);
        
        // Close modal and reload page
        closeLogActivityModal();
        window.location.reload();
    } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;

// Alert Modal Functions
function showAlertModal() {
    document.getElementById('alertModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeAlertModal() {
    document.getElementById('alertModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close alert modal when clicking outside
document.addEventListener('click', function(event) {
    const alertModal = document.getElementById('alertModal');
    if (event.target === alertModal) {
        closeAlertModal();
    }
});
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('logActivityModal');
    if (event.target === modal) {
        closeLogActivityModal();
    }
});
</script>
{% endblock %}