{% extends "base.html" %}

{% block title %}Add Expense{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-plus"></i> Add Expense
    </h1>
    <a href="{{ url_for('expenses_list') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Expenses
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Expense Details</h3>
    </div>
    <div style="padding: 2rem;">
        <form method="POST" action="{{ url_for('add_expense') }}" enctype="multipart/form-data">
            <div style="display: grid; gap: 1.5rem;">
                <!-- Date and Category Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label for="expense_date" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Date <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="date" 
                               name="expense_date" 
                               id="expense_date" 
                               required
                               value="{{ request.form.get('expense_date', '') }}"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    </div>
                    
                    <div>
                        <label for="category" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Category <span style="color: #ef4444;">*</span>
                        </label>
                        <select name="category" 
                                id="category" 
                                required
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                            <option value="">Select Category</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}" {% if request.form.get('category') == cat %}selected{% endif %}>
                                {{ cat }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Amount and Currency Row -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div>
                        <label for="amount" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Amount <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="number" 
                               name="amount" 
                               id="amount" 
                               step="0.01" 
                               min="0" 
                               required
                               value="{{ request.form.get('amount', '') }}"
                               placeholder="0.00"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    </div>
                    
                    <div>
                        <label for="currency" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Currency
                        </label>
                        <select name="currency" 
                                id="currency"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                            <option value="USD" selected>USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="AUD">AUD</option>
                            <option value="CAD">CAD</option>
                        </select>
                    </div>
                </div>
                
                <!-- Reptile Selection -->
                <div>
                    <label for="reptile_id" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Reptile (Optional)
                    </label>
                    <select name="reptile_id" 
                            id="reptile_id"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                        <option value="">General Expense (Not specific to a reptile)</option>
                        {% for reptile in reptiles %}
                        <option value="{{ reptile.id }}" {% if request.form.get('reptile_id') == reptile.id|string %}selected{% endif %}>
                            {{ reptile.name }} ({{ reptile.species }})
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                        Select a reptile if this expense is specific to one animal
                    </small>
                </div>
                
                <!-- Vendor and Payment Method Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label for="vendor" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Vendor/Store
                        </label>
                        <input type="text" 
                               name="vendor" 
                               id="vendor"
                               value="{{ request.form.get('vendor', '') }}"
                               placeholder="e.g., PetSmart, Amazon"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    </div>
                    
                    <div>
                        <label for="payment_method" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                            Payment Method
                        </label>
                        <select name="payment_method" 
                                id="payment_method"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                            <option value="">Select Method</option>
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <!-- Description -->
                <div>
                    <label for="description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Description
                    </label>
                    <input type="text" 
                           name="description" 
                           id="description"
                           value="{{ request.form.get('description', '') }}"
                           placeholder="Brief description of the expense"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                </div>
                
                <!-- Receipt Upload -->
                <div>
                    <label for="receipt" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Receipt (Image or PDF)
                    </label>
                    <div id="drop-zone" style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                        <p style="margin: 0; color: var(--text-secondary);">
                            <strong>Click to upload</strong> or drag and drop
                        </p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">
                            PNG, JPG, or PDF (max 10MB)
                        </p>
                        <input type="file" 
                               name="receipt" 
                               id="receipt" 
                               accept=".png,.jpg,.jpeg,.pdf"
                               style="display: none;">
                    </div>
                    <div id="file-preview" style="margin-top: 1rem; display: none;">
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                            <i class="fas fa-file" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div style="flex: 1;">
                                <div id="file-name" style="font-weight: 500;"></div>
                                <div id="file-size" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                            <button type="button" id="remove-file" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tags -->
                <div>
                    <label for="tags" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Tags
                    </label>
                    <input type="text" 
                           name="tags" 
                           id="tags"
                           value="{{ request.form.get('tags', '') }}"
                           placeholder="e.g., monthly, urgent, bulk-purchase (comma-separated)"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                        Separate multiple tags with commas
                    </small>
                </div>
                
                <!-- Recurring Expense -->
                <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" 
                               name="is_recurring" 
                               id="is_recurring"
                               value="1"
                               {% if request.form.get('is_recurring') %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">This is a recurring expense</span>
                    </label>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem; margin-left: 1.75rem;">
                        Check if this expense repeats regularly (e.g., monthly subscription)
                    </small>
                </div>
                
                <!-- Notes -->
                <div>
                    <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Notes
                    </label>
                    <textarea name="notes" 
                              id="notes" 
                              rows="4"
                              placeholder="Additional notes or details about this expense"
                              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); resize: vertical;">{{ request.form.get('notes', '') }}</textarea>
                </div>
                
                <!-- Submit Buttons -->
                <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Save Expense
                    </button>
                    <a href="{{ url_for('expenses_list') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// File upload handling
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('receipt');
const filePreview = document.getElementById('file-preview');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const removeFileBtn = document.getElementById('remove-file');

// Click to upload
dropZone.addEventListener('click', () => fileInput.click());

// Drag and drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--primary-color)';
    dropZone.style.background = 'rgba(59, 130, 246, 0.05)';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = 'var(--border-color)';
    dropZone.style.background = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--border-color)';
    dropZone.style.background = 'transparent';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        showFilePreview(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFilePreview(e.target.files[0]);
    }
});

// Show file preview
function showFilePreview(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    filePreview.style.display = 'block';
    dropZone.style.display = 'none';
}

// Remove file
removeFileBtn.addEventListener('click', () => {
    fileInput.value = '';
    filePreview.style.display = 'none';
    dropZone.style.display = 'block';
});

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Set today's date as default
document.getElementById('expense_date').valueAsDate = new Date();
</script>

<style>
#drop-zone:hover {
    border-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.05);
}

@media (max-width: 768px) {
    .card {
        padding: 1rem;
    }
    
    div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}