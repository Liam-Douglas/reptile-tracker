{% extends "base.html" %}

{% block title %}Add Feeding Log - Reptile Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Add Feeding Log</h2>
    </div>
    
    <form method="POST">
        {% if reptile %}
        <input type="hidden" name="reptile_id" value="{{ reptile.id }}">
        <div class="form-group">
            <label class="form-label">Reptile</label>
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                <strong>{{ reptile.name }}</strong> ({{ reptile.species }})
            </div>
        </div>
        {% else %}
        <div class="form-group">
            <label class="form-label" for="reptile_id">Reptile *</label>
            <select id="reptile_id" name="reptile_id" class="form-select" required>
                <option value="">Select a reptile...</option>
                {% for r in reptiles %}
                    <option value="{{ r.id }}" {% if request.args.get('reptile_id') == r.id|string %}selected{% endif %}>
                        {{ r.name }} ({{ r.species }})
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label class="form-label" for="date">Date *</label>
            <input type="date" 
                   id="date" 
                   name="date" 
                   class="form-input" 
                   value="{{ log.date if log else '' }}" 
                   required>
        </div>

        <div class="form-group">
            <label class="form-label" for="use_inventory">Use Food from Inventory?</label>
            <select id="use_inventory" name="use_inventory" class="form-select" onchange="toggleInventorySelection()">
                <option value="no">No - Enter manually</option>
                <option value="yes">Yes - Select from inventory</option>
            </select>
        </div>

        <div id="inventory-selection" style="display: none;">
            <div class="form-group">
                <label class="form-label" for="inventory_id">Select Food Item *</label>
                <select id="inventory_id" name="inventory_id" class="form-select">
                    <option value="">Select from inventory...</option>
                    {% for item in inventory_items %}
                        <option value="{{ item.id }}"
                                data-food-type="{{ item.food_type }}"
                                data-food-size="{{ item.food_size }}"
                                data-quantity="{{ item.quantity }}">
                            {{ item.food_type }} - {{ item.food_size }} ({{ item.quantity }} available)
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="inventory_quantity">Quantity *</label>
                <input type="number"
                       id="inventory_quantity"
                       name="inventory_quantity"
                       class="form-input"
                       min="1"
                       value="1">
                <small class="form-help" id="stock-warning" style="color: #ef4444; display: none;">
                    ⚠️ Not enough stock available
                </small>
            </div>
        </div>

        <!-- Hidden fields for food_type and food_size (populated by inventory selection or manual entry) -->
        <input type="hidden" id="food_type_hidden" name="food_type" value="">
        <input type="hidden" id="food_size_hidden" name="food_size" value="">

        <div id="manual-entry" style="display: block;">
            <!-- AI Food Recognition -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-camera"></i> AI Food Recognition (Optional)
                </label>
                <div class="ai-food-section">
                    <input type="file" id="food_image" accept="image/*" capture="environment" style="display: none;" onchange="analyzeFoodImage(event)">
                    <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('food_image').click()">
                        <i class="fas fa-camera"></i> Take Photo of Food
                    </button>
                    <div id="ai_analysis_result" class="ai-result" style="display: none;">
                        <div class="ai-result-header">
                            <i class="fas fa-robot"></i> AI Analysis
                        </div>
                        <div id="ai_result_content"></div>
                    </div>
                    <div id="ai_loading" class="ai-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Analyzing food...
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="quantity">Quantity</label>
                <input type="number"
                       id="quantity"
                       name="quantity"
                       class="form-input"
                       min="1"
                       value="1"
                       placeholder="Default: 1">
            </div>

            <div class="form-group">
                <label class="form-label" for="food_type">Food Type *</label>
                <select id="food_type"
                        class="form-select"
                        required
                        onchange="updateHiddenFields()">
                    <option value="">Select food type...</option>
                    {% for food_type in food_types %}
                        <option value="{{ food_type }}" {% if log and log.food_type == food_type %}selected{% endif %}>{{ food_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="food_size">Food Size</label>
                <select id="food_size"
                        class="form-select"
                        onchange="updateHiddenFields()">
                    <option value="">Select size...</option>
                    {% for food_size in food_sizes %}
                        <option value="{{ food_size }}" {% if log and log.food_size == food_size %}selected{% endif %}>{{ food_size }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="ate">Did they eat? *</label>
            <select id="ate" name="ate" class="form-select" required>
                <option value="yes" {% if log and log.ate %}selected{% endif %}>Yes</option>
                <option value="no" {% if log and not log.ate %}selected{% endif %}>No</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="notes">Notes</label>
            <textarea id="notes" 
                      name="notes" 
                      class="form-textarea" 
                      placeholder="Any observations...">{{ log.notes if log and log.notes else '' }}</textarea>
        </div>

        <div class="btn-group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Add Feeding Log
            </button>
            <a href="{{ url_for('feeding_logs') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();

    // Update hidden fields from visible fields
    function updateHiddenFields() {
        const foodType = document.getElementById('food_type').value;
        const foodSize = document.getElementById('food_size').value;
        document.getElementById('food_type_hidden').value = foodType;
        document.getElementById('food_size_hidden').value = foodSize;
    }

    // Initialize hidden fields on page load
    updateHiddenFields();

    // Toggle between inventory selection and manual entry
    function toggleInventorySelection() {
        const useInventory = document.getElementById('use_inventory').value;
        const inventorySection = document.getElementById('inventory-selection');
        const manualSection = document.getElementById('manual-entry');
        const inventorySelect = document.getElementById('inventory_id');
        const foodTypeInput = document.getElementById('food_type');
        const foodSizeInput = document.getElementById('food_size');
        
        if (useInventory === 'yes') {
            inventorySection.style.display = 'block';
            manualSection.style.display = 'none';
            inventorySelect.required = true;
            foodTypeInput.required = false;
        } else {
            inventorySection.style.display = 'none';
            manualSection.style.display = 'block';
            inventorySelect.required = false;
            foodTypeInput.required = true;
            // Update hidden fields when switching back to manual
            updateHiddenFields();
        }
    }

    // Update food type and size when inventory item is selected
    document.getElementById('inventory_id').addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value) {
            const foodType = selected.getAttribute('data-food-type');
            const foodSize = selected.getAttribute('data-food-size');
            const availableQty = parseInt(selected.getAttribute('data-quantity'));
            
            // Update visible fields (for display purposes)
            document.getElementById('food_type').value = foodType;
            document.getElementById('food_size').value = foodSize || '';
            
            // Update hidden fields for form submission
            document.getElementById('food_type_hidden').value = foodType;
            document.getElementById('food_size_hidden').value = foodSize || '';
            
            // Check quantity against available stock
            checkStock();
        }
    });

    // Check if requested quantity exceeds available stock
    function checkStock() {
        const inventorySelect = document.getElementById('inventory_id');
        const quantityInput = document.getElementById('inventory_quantity');
        const stockWarning = document.getElementById('stock-warning');
        const selected = inventorySelect.options[inventorySelect.selectedIndex];
        
        if (selected.value) {
            const availableQty = parseInt(selected.getAttribute('data-quantity'));
            const requestedQty = parseInt(quantityInput.value) || 1;
            
            if (requestedQty > availableQty) {
                stockWarning.style.display = 'block';
                stockWarning.textContent = `⚠️ Only ${availableQty} available in stock`;
            } else {
                stockWarning.style.display = 'none';
            }
        }
    }

    // Add event listener for quantity changes
    document.getElementById('inventory_quantity').addEventListener('input', checkStock);

    // AI Food Recognition
    async function analyzeFoodImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Show loading
        document.getElementById('ai_loading').style.display = 'block';
        document.getElementById('ai_analysis_result').style.display = 'none';
        
        try {
            // Convert image to base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                // Call API
                const response = await fetch('/api/analyze-food', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('ai_loading').style.display = 'none';
                
                if (result.success) {
                    // Show results
                    displayFoodAnalysis(result);
                    
                    // Auto-fill form fields
                    if (result.food_type) {
                        const foodTypeSelect = document.getElementById('food_type');
                        // Try to match the food type
                        for (let option of foodTypeSelect.options) {
                            if (option.value.toLowerCase() === result.food_type.toLowerCase()) {
                                foodTypeSelect.value = option.value;
                                updateHiddenFields();
                                break;
                            }
                        }
                    }
                    
                    // Add to notes
                    if (result.food_description) {
                        const notesField = document.getElementById('notes');
                        const aiNote = `AI identified: ${result.food_description}`;
                        notesField.value = notesField.value ? `${notesField.value}\n${aiNote}` : aiNote;
                    }
                } else {
                    alert('Failed to analyze image: ' + (result.error || 'Unknown error'));
                }
            };
            reader.readAsDataURL(file);
        } catch (error) {
            document.getElementById('ai_loading').style.display = 'none';
            console.error('Error analyzing food:', error);
            alert('Failed to analyze image. Please try again.');
        }
    }

    function displayFoodAnalysis(result) {
        const resultDiv = document.getElementById('ai_analysis_result');
        const contentDiv = document.getElementById('ai_result_content');
        
        let confidenceClass = 'confidence-medium';
        if (result.confidence === 'high') confidenceClass = 'confidence-high';
        if (result.confidence === 'low') confidenceClass = 'confidence-low';
        
        let html = `
            <div class="ai-result-item">
                <span class="ai-result-label">Food Type:</span>
                <span class="ai-result-value">${result.food_type}</span>
            </div>
        `;
        
        if (result.food_items && result.food_items.length > 0) {
            html += `
                <div class="ai-result-item">
                    <span class="ai-result-label">Items Detected:</span>
                    <span class="ai-result-value">${result.food_items.join(', ')}</span>
                </div>
            `;
        }
        
        if (result.description) {
            html += `
                <div class="ai-result-item">
                    <span class="ai-result-label">Description:</span>
                    <span class="ai-result-value">${result.description}</span>
                </div>
            `;
        }
        
        html += `
            <div class="ai-result-item">
                <span class="ai-result-label">Confidence:</span>
                <span class="confidence-badge ${confidenceClass}">${result.confidence.toUpperCase()}</span>
            </div>
        `;
        
        contentDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }
</script>

<style>
/* AI Food Recognition Styles */
.ai-food-section {
    margin-top: 0.5rem;
}

.btn-block {
    width: 100%;
    justify-content: center;
}

.ai-result {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 2px solid #4CAF50;
}

.ai-result-header {
    font-weight: 600;
    color: #4CAF50;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-result-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.ai-result-item:last-child {
    border-bottom: none;
}

.ai-result-label {
    font-weight: 600;
    color: var(--text-secondary);
    margin-right: 0.5rem;
}

.ai-result-value {
    color: var(--text-primary);
}

.ai-loading {
    margin-top: 1rem;
    padding: 1rem;
    text-align: center;
    color: var(--text-secondary);
    background: var(--bg-secondary);
    border-radius: 8px;
}

.confidence-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.confidence-high {
    background: #4CAF50;
    color: white;
}

.confidence-medium {
    background: #FF9800;
    color: white;
}

.confidence-low {
    background: #9E9E9E;
    color: white;
}
</style>
{% endblock %}