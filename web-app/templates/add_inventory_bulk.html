{% extends "base.html" %}

{% block title %}Add Food Stock{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-plus"></i> Add Food Stock & Track Expenses
    </h1>
    <a href="{{ url_for('food_inventory') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Inventory
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Add Multiple Items</h3>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary); font-weight: normal;">
            Add one or multiple food items to your inventory in a single submission
        </p>
    </div>
    <div style="padding: 2rem;">
        <form method="POST" action="{{ url_for('add_inventory_bulk') }}" id="bulk-inventory-form">
            <!-- Purchase Info Section -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                    <i class="fas fa-receipt"></i> Purchase Information (Optional)
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Purchase Date</label>
                        <input type="date" 
                               name="purchase_date" 
                               id="purchase_date"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Supplier/Store</label>
                        <input type="text" 
                               name="supplier"
                               placeholder="e.g., PetSmart, Local Breeder"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Payment Method</label>
                        <select name="payment_method"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                            <option value="">Select...</option>
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Items Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--primary-color);">
                        <i class="fas fa-box"></i> Food Items
                    </h4>
                    <button type="button" onclick="addItem()" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Add Another Item
                    </button>
                </div>

                <div id="items-container">
                    <!-- First item will be added by JavaScript on page load -->
                </div>
            </div>

            <!-- Total Cost Display -->
            <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; font-size: 1.1rem;">Total Cost:</span>
                    <span id="total-cost" style="font-weight: 700; font-size: 1.5rem; color: var(--primary-color);">$0.00</span>
                </div>
            </div>

            <!-- Notes -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes</label>
                <textarea name="notes" 
                          rows="3"
                          placeholder="Additional notes about this purchase"
                          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); resize: vertical;"></textarea>
            </div>

            <!-- Submit Buttons -->
            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Add All Items to Inventory
                </button>
                <a href="{{ url_for('food_inventory') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
let itemIndex = 0;
const foodTypes = {{ food_types|tojson }};
const foodSizes = {{ food_sizes|tojson }};

// Set today's date as default
document.getElementById('purchase_date').valueAsDate = new Date();

function addItem() {
    const container = document.getElementById('items-container');
    const index = itemIndex++;
    
    const itemDiv = document.createElement('div');
    itemDiv.className = 'inventory-item';
    itemDiv.id = `item-${index}`;
    itemDiv.innerHTML = `
        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px; border: 2px solid var(--border-color); margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h5 style="margin: 0; color: var(--text-primary);">
                    <i class="fas fa-box"></i> Item #${index + 1}
                </h5>
                <button type="button" onclick="removeItem(${index})" class="btn btn-danger btn-sm" ${index === 0 ? 'style="display: none;"' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Food Type <span style="color: #ef4444;">*</span>
                    </label>
                    <select name="food_type_${index}" required onchange="updateTotal()"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                        <option value="">Select...</option>
                        ${foodTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Size <span style="color: #ef4444;">*</span>
                    </label>
                    <select name="food_size_${index}" required onchange="updateTotal()"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                        <option value="">Select...</option>
                        ${foodSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Quantity <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="number" name="quantity_${index}" min="1" value="1" required onchange="updateTotal()"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Unit</label>
                    <select name="unit_${index}"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                        <option value="items">items</option>
                        <option value="grams">grams</option>
                        <option value="ounces">ounces</option>
                        <option value="pounds">pounds</option>
                        <option value="dozen">dozen</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Cost Per Unit</label>
                    <input type="number" name="cost_per_unit_${index}" min="0" step="0.01" placeholder="0.00" onchange="updateTotal()"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Expiry Date</label>
                    <input type="date" name="expiry_date_${index}"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(itemDiv);
    updateTotal();
}

function removeItem(index) {
    const item = document.getElementById(`item-${index}`);
    if (item) {
        item.remove();
        updateTotal();
    }
}

function updateTotal() {
    let total = 0;
    const items = document.querySelectorAll('.inventory-item');
    
    items.forEach((item, idx) => {
        const quantityInput = item.querySelector(`input[name^="quantity_"]`);
        const costInput = item.querySelector(`input[name^="cost_per_unit_"]`);
        
        if (quantityInput && costInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const cost = parseFloat(costInput.value) || 0;
            total += quantity * cost;
        }
    });
    
    document.getElementById('total-cost').textContent = `$${total.toFixed(2)}`;
}

// Add first item on page load
window.addEventListener('DOMContentLoaded', () => {
    addItem();
});
</script>

<style>
@media (max-width: 768px) {
    div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}