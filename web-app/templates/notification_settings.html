{% extends "base.html" %}

{% block title %}Notification Settings - Reptile Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìß Notification Settings</h1>
    <p>Configure email, SMS, and push notifications for feeding schedules</p>
</div>

<div class="settings-container">
    <form method="POST" action="{{ url_for('notification_settings') }}" class="settings-form">
        
        <!-- Email Settings -->
        <div class="settings-section">
            <h2>üìß Email Notifications</h2>
            <p class="section-description">Receive feeding reminders via email</p>
            
            <div class="form-group">
                <label for="email_enabled">
                    <input type="checkbox" id="email_enabled" name="email_enabled" 
                           {% if settings.email_enabled %}checked{% endif %}>
                    Enable Email Notifications
                </label>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" 
                       value="{{ settings.email or '' }}" 
                       placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label for="reminder_time">Daily Reminder Time</label>
                <input type="time" id="reminder_time" name="reminder_time" 
                       value="{{ settings.reminder_time or '09:00' }}">
                <small>Time to check for overdue feedings and send reminders</small>
            </div>
        </div>
        
        <!-- SMS Settings -->
        <div class="settings-section">
            <h2>üì± SMS Notifications</h2>
            <p class="section-description">Receive feeding reminders via text message (requires Twilio setup)</p>
            
            <div class="form-group">
                <label for="sms_enabled">
                    <input type="checkbox" id="sms_enabled" name="sms_enabled" 
                           {% if settings.sms_enabled %}checked{% endif %}>
                    Enable SMS Notifications
                </label>
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" 
                       value="{{ settings.phone or '' }}" 
                       placeholder="+1234567890">
                <small>Include country code (e.g., +1 for US, +61 for Australia)</small>
            </div>
        </div>
        
        <!-- Notification Preferences -->
        <div class="settings-section">
            <h2>‚öôÔ∏è Notification Preferences</h2>
            
            <div class="form-group">
                <label for="notification_types">What to notify about</label>
                <select id="notification_types" name="notification_types" class="form-control">
                    <option value="all" {% if settings.notification_types == 'all' or not settings.notification_types %}selected{% endif %}>
                        All (Overdue + Upcoming)
                    </option>
                    <option value="overdue_only" {% if settings.notification_types == 'overdue_only' %}selected{% endif %}>
                        Overdue feedings only
                    </option>
                    <option value="upcoming_only" {% if settings.notification_types == 'upcoming_only' %}selected{% endif %}>
                        Upcoming feedings only
                    </option>
                </select>
                <small>Choose which types of feeding reminders to receive</small>
            </div>
            
            <div class="form-group">
                <label for="notification_frequency">Notification frequency</label>
                <select id="notification_frequency" name="notification_frequency" class="form-control">
                    <option value="once_daily" {% if settings.notification_frequency == 'once_daily' or not settings.notification_frequency %}selected{% endif %}>
                        Once daily (at reminder time)
                    </option>
                    <option value="daily_while_overdue" {% if settings.notification_frequency == 'daily_while_overdue' %}selected{% endif %}>
                        Daily while overdue
                    </option>
                    <option value="every_12h_overdue" {% if settings.notification_frequency == 'every_12h_overdue' %}selected{% endif %}>
                        Every 12 hours while overdue
                    </option>
                </select>
                <small>How often to send notifications for overdue feedings</small>
            </div>
            
            <div class="form-group">
                <label for="upcoming_days">Upcoming reminder (days ahead)</label>
                <input type="number" id="upcoming_days" name="upcoming_days"
                       value="{{ settings.upcoming_days or 1 }}"
                       min="0" max="7" class="form-control">
                <small>Send reminder this many days before feeding is due (0 = day of only)</small>
            </div>
            
            <div class="form-group">
                <label for="quiet_hours_start">Quiet hours (optional)</label>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1;">
                        <input type="time" id="quiet_hours_start" name="quiet_hours_start"
                               value="{{ settings.quiet_hours_start or '' }}"
                               class="form-control"
                               placeholder="Start">
                        <small>Start time</small>
                    </div>
                    <span>to</span>
                    <div style="flex: 1;">
                        <input type="time" id="quiet_hours_end" name="quiet_hours_end"
                               value="{{ settings.quiet_hours_end or '' }}"
                               class="form-control"
                               placeholder="End">
                        <small>End time</small>
                    </div>
                </div>
                <small>No notifications will be sent during these hours (leave empty to disable)</small>
            </div>
            
            <div class="form-group">
                <label for="group_notifications">
                    <input type="checkbox" id="group_notifications" name="group_notifications"
                           {% if settings.group_notifications %}checked{% endif %}>
                    Group multiple reminders into one notification
                </label>
                <small>Combine all due feedings into a single notification instead of separate ones</small>
            </div>
        </div>
        
        <!-- Push Notification Settings -->
        <div class="settings-section">
            <h2>üîî Push Notifications (Web/Mobile)</h2>
            <p class="section-description">Receive instant notifications on your devices</p>
            
            <div class="form-group">
                <label for="push_enabled">
                    <input type="checkbox" id="push_enabled" name="push_enabled"
                           {% if settings.push_enabled %}checked{% endif %}>
                    Enable Push Notifications
                </label>
            </div>
            
            <div class="form-group">
                <button type="button" onclick="requestPushPermission()" class="btn btn-secondary">
                    <i class="fas fa-bell"></i> Enable Push on This Device
                </button>
                <small>Click to allow push notifications on this device</small>
            </div>
            
            <div class="form-group">
                <label>Registered Devices</label>
                <div id="device-list" style="margin-top: 0.5rem;">
                    <p style="color: var(--text-secondary);">Loading devices...</p>
                </div>
            </div>
            
            <div class="form-group">
                <button type="button" onclick="sendTestPushNotification()" class="btn btn-secondary">
                    üîî Send Test Push Notification
                </button>
                <small>Test push notifications on all registered devices</small>
            </div>
        </div>
        
        <!-- Test Notification -->
        <div class="settings-section">
            <h2>üß™ Test Notifications</h2>
            <p class="section-description">Send a test notification to verify your settings</p>
            
            <div class="button-group">
                <button type="button" onclick="sendTestEmail()" class="btn btn-secondary">
                    üìß Send Test Email
                </button>
                <button type="button" onclick="sendTestSMS()" class="btn btn-secondary">
                    üì± Send Test SMS
                </button>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    
    <!-- Setup Instructions -->
    <div class="setup-instructions">
        <h2>üìã Setup Instructions</h2>
        
        <div class="instruction-section">
            <h3>Email Setup (Gmail Example)</h3>
            <ol>
                <li>Go to Render Dashboard ‚Üí Your Service ‚Üí Environment</li>
                <li>Add these environment variables:
                    <ul>
                        <li><code>SMTP_ENABLED=true</code></li>
                        <li><code>SMTP_SERVER=smtp.gmail.com</code></li>
                        <li><code>SMTP_PORT=587</code></li>
                        <li><code>SMTP_USERNAME=your-email@gmail.com</code></li>
                        <li><code>SMTP_PASSWORD=your-app-password</code></li>
                        <li><code>FROM_EMAIL=your-email@gmail.com</code></li>
                    </ul>
                </li>
                <li>For Gmail, create an <a href="https://support.google.com/accounts/answer/185833" target="_blank">App Password</a></li>
                <li>Redeploy your service</li>
            </ol>
        </div>
        
        <div class="instruction-section">
            <h3>SMS Setup (Twilio)</h3>
            <ol>
                <li>Sign up for <a href="https://www.twilio.com/try-twilio" target="_blank">Twilio</a> (free trial available)</li>
                <li>Get your Account SID, Auth Token, and Phone Number</li>
                <li>Add these environment variables in Render:
                    <ul>
                        <li><code>TWILIO_ENABLED=true</code></li>
                        <li><code>TWILIO_ACCOUNT_SID=your-account-sid</code></li>
                        <li><code>TWILIO_AUTH_TOKEN=your-auth-token</code></li>
                        <li><code>TWILIO_PHONE_NUMBER=+1234567890</code></li>
                    </ul>
                </li>
                <li>Redeploy your service</li>
            </ol>
        </div>
        
        <div class="instruction-section">
            <h3>Push Notifications Setup</h3>
            <ol>
                <li>VAPID keys are automatically generated on first use</li>
                <li>Check your server logs for the generated keys</li>
                <li>Add them to Render environment variables:
                    <ul>
                        <li><code>VAPID_PRIVATE_KEY=your-private-key</code></li>
                        <li><code>VAPID_PUBLIC_KEY=your-public-key</code></li>
                    </ul>
                </li>
                <li>Redeploy your service</li>
                <li>Click "Enable Push on This Device" above to register</li>
            </ol>
        </div>
    </div>
</div>

<script>
// Push Notification Functions
const VAPID_PUBLIC_KEY = '{{ vapid_public_key }}';

async function requestPushPermission() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('‚ùå Push notifications are not supported in your browser');
        return;
    }
    
    if (!VAPID_PUBLIC_KEY) {
        alert('‚ùå VAPID keys not configured. Check server logs for generated keys.');
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
            
            // Send subscription to server
            const response = await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subscription: subscription.toJSON(),
                    device_name: getDeviceName()
                })
            });
            
            if (response.ok) {
                alert('‚úÖ Push notifications enabled on this device!');
                loadDeviceList();
            } else {
                const error = await response.json();
                alert('‚ùå Failed to register device: ' + (error.message || 'Unknown error'));
            }
        } else {
            alert('‚ùå Permission denied for push notifications');
        }
    } catch (error) {
        console.error('Error enabling push notifications:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

function getDeviceName() {
    const ua = navigator.userAgent;
    if (/iPhone/.test(ua)) return 'iPhone';
    if (/iPad/.test(ua)) return 'iPad';
    if (/Android/.test(ua)) return 'Android';
    if (/Mac/.test(ua)) return 'Mac';
    if (/Windows/.test(ua)) return 'Windows';
    if (/Linux/.test(ua)) return 'Linux';
    return 'Unknown Device';
}

async function loadDeviceList() {
    try {
        const response = await fetch('/api/push/devices');
        const data = await response.json();
        
        const deviceList = document.getElementById('device-list');
        if (!data.success || data.devices.length === 0) {
            deviceList.innerHTML = '<p style="color: var(--text-secondary);">No devices registered yet</p>';
        } else {
            deviceList.innerHTML = data.devices.map(device => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 0.5rem;">
                    <div>
                        <i class="fas fa-mobile-alt"></i> ${device.device_info || 'Unknown Device'}
                        <br>
                        <small style="color: var(--text-secondary);">Registered: ${new Date(device.created_at).toLocaleDateString()}</small>
                    </div>
                    <button onclick="removeDevice(${device.id})" class="btn btn-sm btn-danger" type="button">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading devices:', error);
        document.getElementById('device-list').innerHTML = '<p style="color: red;">Error loading devices</p>';
    }
}

async function removeDevice(deviceId) {
    if (!confirm('Remove this device from notifications?')) return;
    
    try {
        const response = await fetch(`/api/push/device/${deviceId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('‚úÖ Device removed');
            loadDeviceList();
        } else {
            alert('‚ùå Failed to remove device');
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

async function sendTestPushNotification() {
    try {
        const response = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'push'
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå ' + data.message);
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

function sendTestEmail() {
    if (!document.getElementById('email').value) {
        alert('Please enter an email address first');
        return;
    }
    
    fetch('/api/send-test-notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'email',
            email: document.getElementById('email').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Test email sent! Check your inbox.');
        } else {
            alert('‚ùå Failed to send test email: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error);
    });
}

function sendTestSMS() {
    if (!document.getElementById('phone').value) {
        alert('Please enter a phone number first');
        return;
    }
    
    fetch('/api/send-test-notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'sms',
            phone: document.getElementById('phone').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Test SMS sent! Check your phone.');
        } else {
            alert('‚ùå Failed to send test SMS: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error);
    });
}

// Load device list on page load
document.addEventListener('DOMContentLoaded', loadDeviceList);
</script>

<style>
.settings-container {
    max-width: 800px;
    margin: 0 auto;
}

.settings-form {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #e0e0e0;
}

.settings-section:last-of-type {
    border-bottom: none;
}

.settings-section h2 {
    margin-top: 0;
    color: #2c5f2d;
}

.section-description {
    color: #666;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input[type="email"],
.form-group input[type="tel"],
.form-group input[type="time"],
.form-group input[type="number"],
.form-group select.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.form-group small {
    display: block;
    color: #666;
    margin-top: 5px;
    font-size: 12px;
}

.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

.setup-instructions {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
}

.setup-instructions h2 {
    margin-top: 0;
    color: #2c5f2d;
}

.instruction-section {
    margin-bottom: 30px;
}

.instruction-section h3 {
    color: #555;
    margin-bottom: 10px;
}

.instruction-section ol {
    margin-left: 20px;
}

.instruction-section li {
    margin-bottom: 10px;
}

.instruction-section code {
    background: #fff;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 13px;
}

.instruction-section a {
    color: #2c5f2d;
    text-decoration: underline;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #c82333;
}
</style>
{% endblock %}