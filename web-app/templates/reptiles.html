{% extends "base.html" %}

{% block title %}My Reptiles - Reptile Tracker{% endblock %}

{% block content %}
<div class="reptiles-page-modern">
    <!-- Modern Header -->
    <div class="modern-header">
        <div class="header-content">
            <div>
                <h1 class="header-title">
                    <i class="fas fa-dragon"></i> My Reptiles
                </h1>
                <p class="header-subtitle">Manage your collection, records, and reminders</p>
            </div>
            <div class="header-actions">
                <div class="header-stats-mini">
                    <div class="mini-stat">
                        <div class="mini-stat-value">{{ reptiles|length }}</div>
                        <div class="mini-stat-label">Total Reptiles</div>
                    </div>
                </div>
                <a href="{{ url_for('add_reptile') }}" class="btn-modern btn-primary">
                    <i class="fas fa-plus"></i> Add Reptile
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="reptiles-tabs">
        <button class="reptiles-tab active" onclick="switchReptileTab('collection')">
            <i class="fas fa-th-large"></i> Collection
        </button>
        <button class="reptiles-tab" onclick="switchReptileTab('records')">
            <i class="fas fa-clipboard-list"></i> Records
        </button>
        <button class="reptiles-tab" onclick="switchReptileTab('reminders')">
            <i class="fas fa-bell"></i> Reminders
        </button>
    </div>

    <!-- Collection Tab -->
    <div id="collection-tab" class="reptiles-tab-content active">
        {% if reptiles %}
            <div class="reptiles-grid-modern">
                {% for reptile in reptiles %}
                <div class="reptile-card-detailed">
                    <!-- Card Image -->
                    <div class="card-image-wrapper">
                        {% if reptile.image_path %}
                            <img src="{{ url_for('uploaded_file', filename=reptile.image_path) }}" alt="{{ reptile.name }}" class="card-img">
                        {% else %}
                            <div class="card-img-placeholder">
                                <i class="fas fa-dragon"></i>
                            </div>
                        {% endif %}
                        <div class="card-overlay">
                            <a href="{{ url_for('reptile_details', reptile_id=reptile.id) }}" class="view-details-btn">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>

                    <!-- Card Content -->
                    <div class="card-body-detailed">
                        <!-- Name, Age, and Sex -->
                        <div class="card-header-row">
                            <h3 class="card-name">
                                {{ reptile.name }}
                                {% if reptile.date_of_birth %}
                                    <span style="font-size: 0.7em; font-weight: normal; color: #6b7280; margin-left: 0.5rem;">
                                        ({{ reptile.date_of_birth|calculate_age }})
                                    </span>
                                {% endif %}
                            </h3>
                            {% if reptile.sex %}
                                {% if reptile.sex == 'Male' %}
                                    <span class="sex-icon male"><i class="fas fa-mars"></i></span>
                                {% elif reptile.sex == 'Female' %}
                                    <span class="sex-icon female"><i class="fas fa-venus"></i></span>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Species -->
                        <div class="card-species">
                            <i class="fas fa-dragon"></i> {{ reptile.species }}
                        </div>

                        <!-- Morph Badge -->
                        {% if reptile.morph %}
                            <div class="morph-badge-wrapper">
                                <span class="morph-badge">
                                    <i class="fas fa-palette"></i> {{ reptile.morph }}
                                </span>
                            </div>
                        {% endif %}

                        <!-- Feeding Status -->
                        {% if reptile.last_feeding_date %}
                            {% set days_text = reptile.last_feeding_date|days_ago %}
                            {% if days_text == 'Today' %}
                                <div class="feeding-status-bar fed-today">
                                    <i class="fas fa-utensils"></i> Fed {{ days_text|lower }}
                                </div>
                            {% elif 'day ago' in days_text or 'days ago' in days_text %}
                                {% set days_num = days_text.split()[0]|int if days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 3 %}
                                    <div class="feeding-status-bar fed-recent">
                                        <i class="fas fa-utensils"></i> Fed {{ days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar fed-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Fed {{ days_text|lower }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="feeding-status-bar no-data">
                                    <i class="fas fa-info-circle"></i> No feeding recorded
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No feeding recorded
                            </div>
                        {% endif %}

                        <!-- Next Feeding Date (right after feeding status) -->
                        {% if reptile.next_feeding_date %}
                            {% set next_days_text = reptile.next_feeding_date|days_until %}
                            {% if next_days_text == 'Today' %}
                                <div class="feeding-status-bar next-feeding-today">
                                    <i class="fas fa-calendar-check"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% elif 'in' in next_days_text %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% elif 'day' in next_days_text or 'days' in next_days_text %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next fed {{ next_days_text|lower }}
                                </div>
                            {% else %}
                                <div class="feeding-status-bar next-feeding-upcoming">
                                    <i class="fas fa-calendar-alt"></i> Next feeding: {{ reptile.next_feeding_date|format_date }}
                                </div>
                            {% endif %}
                        {% endif %}

                        <!-- Tank Last Cleaned -->
                        {% if reptile.last_tank_cleaning_date %}
                            {% set cleaning_days_text = reptile.last_tank_cleaning_date|days_ago %}
                            {% if cleaning_days_text == 'Today' %}
                                <div class="feeding-status-bar tank-cleaned-today">
                                    <i class="fas fa-spray-can"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                </div>
                            {% elif 'day ago' in cleaning_days_text or 'days ago' in cleaning_days_text %}
                                {% set days_num = cleaning_days_text.split()[0]|int if cleaning_days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 7 %}
                                    <div class="feeding-status-bar tank-cleaned-recent">
                                        <i class="fas fa-spray-can"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar tank-cleaned-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Tank cleaned {{ cleaning_days_text|lower }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No tank cleaning recorded
                            </div>
                        {% endif %}

                        <!-- Last Handled -->
                        {% if reptile.last_handling_date %}
                            {% set handling_days_text = reptile.last_handling_date|days_ago %}
                            {% if handling_days_text == 'Today' %}
                                <div class="feeding-status-bar handled-today">
                                    <i class="fas fa-hand-holding"></i> Handled {{ handling_days_text|lower }}
                                </div>
                            {% elif 'day ago' in handling_days_text or 'days ago' in handling_days_text %}
                                {% set days_num = handling_days_text.split()[0]|int if handling_days_text.split()[0].isdigit() else 0 %}
                                {% if days_num <= 7 %}
                                    <div class="feeding-status-bar handled-recent">
                                        <i class="fas fa-hand-holding"></i> Handled {{ handling_days_text|lower }}
                                    </div>
                                {% else %}
                                    <div class="feeding-status-bar handled-overdue">
                                        <i class="fas fa-exclamation-circle"></i> Handled {{ handling_days_text|lower }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="feeding-status-bar no-data">
                                <i class="fas fa-info-circle"></i> No handling recorded
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state-large">
                <i class="fas fa-dragon"></i>
                <h3>No Reptiles Yet</h3>
                <p>Add your first reptile to start tracking their care</p>
                <a href="{{ url_for('add_reptile') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Your First Reptile
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Records Tab -->
    <div id="records-tab" class="reptiles-tab-content">
        <div class="records-container">
            <!-- Quick Actions -->
            <div class="quick-actions-bar">
                <button onclick="showLogActivityModal()" class="action-btn primary">
                    <i class="fas fa-plus"></i> Log Activity
                </button>
            </div>

            <!-- Log Activity Modal -->
            <div id="logActivityModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-clipboard-list"></i> What would you like to log?</h3>
                        <button class="modal-close" onclick="closeLogActivityModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <a href="{{ url_for('add_feeding') }}" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <h4>Feeding</h4>
                                <p>Log a feeding session</p>
                            </a>
                            <a href="{{ url_for('add_shed') }}" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <h4>Shed</h4>
                                <p>Record a shed event</p>
                            </a>
                            <a href="#" onclick="event.preventDefault(); selectReptileForCleaning();" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                                    <i class="fas fa-spray-can"></i>
                                </div>
                                <h4>Tank Cleaning</h4>
                                <p>Log tank maintenance</p>
                            </a>
                            <a href="#" onclick="event.preventDefault(); selectReptileForHandling();" class="log-option-card">
                                <div class="log-option-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                                    <i class="fas fa-hand-holding"></i>
                                </div>
                                <h4>Handling</h4>
                                <p>Record handling session</p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Grid -->
            <div class="records-grid-modern">
                <!-- Feeding Logs -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-utensils"></i> Recent Feedings</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ feeding_logs|length }} records</span>
                            <a href="{{ url_for('feeding_logs') }}" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if feeding_logs %}
                            <div class="records-list-modern">
                                {% for log in feeding_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle feeding">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">{{ log.food_type }}{% if log.food_size %} ({{ log.food_size }}){% endif %}</div>
                                        <div class="record-date">{{ log.feeding_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        {% if log.ate %}
                                            <span class="badge-success"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge-danger"><i class="fas fa-times"></i></span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-utensils"></i>
                                <p>No feeding records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Shed Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-sync-alt"></i> Recent Sheds</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ shed_records|length }} records</span>
                            <a href="{{ url_for('shed_records') }}" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if shed_records %}
                            <div class="records-list-modern">
                                {% for record in shed_records[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle shed">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ record.reptile_name }}</div>
                                        <div class="record-details">Shed Record</div>
                                        <div class="record-date">{{ record.shed_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        {% if record.complete %}
                                            <span class="badge-success"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge-warning"><i class="fas fa-exclamation"></i></span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-sync-alt"></i>
                                <p>No shed records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tank Cleaning Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-spray-can"></i> Recent Tank Cleanings</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ tank_cleaning_logs|length }} records</span>
                            <a href="{{ url_for('records_page') }}#tank-cleaning" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if tank_cleaning_logs %}
                            <div class="records-list-modern">
                                {% for log in tank_cleaning_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle" style="background: linear-gradient(135deg, #99f6e4, #5eead4);">
                                        <i class="fas fa-spray-can"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">{{ log.cleaning_type }}</div>
                                        <div class="record-date">{{ log.cleaning_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        <span class="badge-success"><i class="fas fa-check"></i></span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-spray-can"></i>
                                <p>No tank cleaning records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Handling Records -->
                <div class="records-section-card">
                    <div class="section-card-header">
                        <h3><i class="fas fa-hand-holding"></i> Recent Handling</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="count-badge">{{ handling_logs|length }} records</span>
                            <a href="{{ url_for('records_page') }}#handling" class="action-btn outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                    <div class="section-card-body">
                        {% if handling_logs %}
                            <div class="records-list-modern">
                                {% for log in handling_logs[:15] %}
                                <div class="record-row">
                                    <div class="record-icon-circle" style="background: linear-gradient(135deg, #f9a8d4, #f472b6);">
                                        <i class="fas fa-hand-holding"></i>
                                    </div>
                                    <div class="record-info">
                                        <div class="record-name">{{ log.reptile_name }}</div>
                                        <div class="record-details">
                                            {% if log.duration_minutes %}{{ log.duration_minutes }} min{% endif %}
                                            {% if log.behavior %} â€¢ {{ log.behavior }}{% endif %}
                                        </div>
                                        <div class="record-date">{{ log.handling_date|format_date }}</div>
                                    </div>
                                    <div class="record-badge">
                                        <span class="badge-success"><i class="fas fa-check"></i></span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-small">
                                <i class="fas fa-hand-holding"></i>
                                <p>No handling records yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminders Tab -->
    <div id="reminders-tab" class="reptiles-tab-content">
        <div class="reminders-container">
            <!-- Quick Actions -->
            <div class="quick-actions-bar">
                <a href="{{ url_for('feeding_reminders') }}" class="action-btn primary">
                    <i class="fas fa-plus"></i> Set New Reminder
                </a>
                <a href="{{ url_for('feeding_reminders') }}" class="action-btn outline">
                    <i class="fas fa-cog"></i> Manage All Reminders
                </a>
            </div>

            <!-- Alerts -->
            {% if overdue_feedings %}
            <div class="alert-card danger">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h3>Overdue Feedings ({{ overdue_feedings|length }})</h3>
                    <ul class="alert-list">
                        {% for feeding in overdue_feedings %}
                        <li>
                            <strong>{{ feeding.reptile_name }}</strong> - Last fed {{ feeding.last_feeding_date|format_date }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {% if upcoming_feedings %}
            <div class="alert-card info">
                <div class="alert-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="alert-content">
                    <h3>Upcoming Feedings ({{ upcoming_feedings|length }})</h3>
                    <ul class="alert-list">
                        {% for feeding in upcoming_feedings %}
                        <li>
                            <strong>{{ feeding.reptile_name }}</strong> - Due {{ feeding.next_feeding_date|format_date }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Active Reminders -->
            <div class="reminders-section-card">
                <div class="section-card-header">
                    <h3><i class="fas fa-bell"></i> Active Reminders</h3>
                    <span class="count-badge">{{ reminders|length if reminders else 0 }} active</span>
                </div>
                <div class="section-card-body">
                    {% if reminders %}
                        <div class="reminders-list-modern">
                            {% for reminder in reminders %}
                            <div class="reminder-row">
                                <div class="reminder-icon-circle">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="reminder-info">
                                    <div class="reminder-name">{{ reminder.reptile_name }}</div>
                                    <div class="reminder-schedule">Every {{ reminder.frequency_days }} days</div>
                                </div>
                                <div class="reminder-actions">
                                    <div class="reminder-status">
                                        {% if reminder.enabled %}
                                            <span class="status-active"><i class="fas fa-check-circle"></i> Active</span>
                                        {% else %}
                                            <span class="status-paused"><i class="fas fa-pause-circle"></i> Paused</span>
                                        {% endif %}
                                    </div>
                                    <a href="{{ url_for('set_feeding_reminder', reptile_id=reminder.reptile_id) }}" class="edit-reminder-btn">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state-small">
                            <i class="fas fa-bell-slash"></i>
                            <p>No active reminders</p>
                            <a href="{{ url_for('feeding_reminders') }}" class="btn btn-secondary" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Set Your First Reminder
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.log-option-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.log-option-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.log-option-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: white;
    font-size: 1.5rem;
}

.log-option-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.log-option-card p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
}
</style>

<script>
function switchReptileTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.reptiles-tab-content');
    tabContents.forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    const tabs = document.querySelectorAll('.reptiles-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked tab
    event.target.closest('.reptiles-tab').classList.add('active');
}

function showLogActivityModal() {
    document.getElementById('logActivityModal').style.display = 'flex';
}

function closeLogActivityModal() {
    document.getElementById('logActivityModal').style.display = 'none';
}

function selectReptileForCleaning() {
    // For now, just redirect to records page where they can select
    // In future, could show reptile selector modal
    window.location.href = "{{ url_for('records_page') }}";
}

function selectReptileForHandling() {
    // For now, just redirect to records page where they can select
    // In future, could show reptile selector modal
    window.location.href = "{{ url_for('records_page') }}";
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('logActivityModal');
    if (event.target === modal) {
        closeLogActivityModal();
    }
});
</script>
{% endblock %}