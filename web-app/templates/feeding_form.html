{% extends "base.html" %}

{% block title %}Add Feeding Log - Reptile Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Add Feeding Log</h2>
    </div>
    
    <form method="POST">
        {% if reptile %}
        <input type="hidden" name="reptile_id" value="{{ reptile.id }}">
        <div class="form-group">
            <label class="form-label">Reptile</label>
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                <strong>{{ reptile.name }}</strong> ({{ reptile.species }})
            </div>
        </div>
        {% else %}
        <div class="form-group">
            <label class="form-label" for="reptile_id">Reptile *</label>
            <select id="reptile_id" name="reptile_id" class="form-select" required>
                <option value="">Select a reptile...</option>
                {% for r in reptiles %}
                    <option value="{{ r.id }}" {% if request.args.get('reptile_id') == r.id|string %}selected{% endif %}>
                        {{ r.name }} ({{ r.species }})
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label class="form-label" for="date">Date *</label>
            <input type="date" 
                   id="date" 
                   name="date" 
                   class="form-input" 
                   value="{{ log.date if log else '' }}" 
                   required>
        </div>

        <div class="form-group">
            <label class="form-label" for="use_inventory">Use Food from Inventory?</label>
            <select id="use_inventory" name="use_inventory" class="form-select" onchange="toggleInventorySelection()">
                <option value="no">No - Enter manually</option>
                <option value="yes">Yes - Select from inventory</option>
            </select>
        </div>

        <div id="inventory-selection" style="display: none;">
            <div class="form-group">
                <label class="form-label" for="inventory_id">Select Food Item *</label>
                <select id="inventory_id" name="inventory_id" class="form-select">
                    <option value="">Select from inventory...</option>
                    {% for item in inventory_items %}
                        <option value="{{ item.id }}"
                                data-food-type="{{ item.food_type }}"
                                data-food-size="{{ item.food_size }}"
                                data-quantity="{{ item.quantity }}">
                            {{ item.food_type }} - {{ item.food_size }} ({{ item.quantity }} available)
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="inventory_quantity">Quantity *</label>
                <input type="number"
                       id="inventory_quantity"
                       name="inventory_quantity"
                       class="form-input"
                       min="1"
                       value="1">
                <small class="form-help" id="stock-warning" style="color: #ef4444; display: none;">
                    ⚠️ Not enough stock available
                </small>
            </div>
        </div>

        <!-- Hidden fields for food_type and food_size (populated by inventory selection or manual entry) -->
        <input type="hidden" id="food_type_hidden" name="food_type" value="">
        <input type="hidden" id="food_size_hidden" name="food_size" value="">

        <div id="manual-entry" style="display: block;">
            <div class="form-group">
                <label class="form-label" for="quantity">Quantity</label>
                <input type="number"
                       id="quantity"
                       name="quantity"
                       class="form-input"
                       min="1"
                       value="1"
                       placeholder="Default: 1">
            </div>

            <div class="form-group">
                <label class="form-label" for="food_type">Food Type *</label>
                <select id="food_type"
                        class="form-select"
                        required
                        onchange="updateHiddenFields()">
                    <option value="">Select food type...</option>
                    {% for food_type in food_types %}
                        <option value="{{ food_type }}" {% if log and log.food_type == food_type %}selected{% endif %}>{{ food_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="food_size">Food Size</label>
                <select id="food_size"
                        class="form-select"
                        onchange="updateHiddenFields()">
                    <option value="">Select size...</option>
                    {% for food_size in food_sizes %}
                        <option value="{{ food_size }}" {% if log and log.food_size == food_size %}selected{% endif %}>{{ food_size }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="ate">Did they eat? *</label>
            <select id="ate" name="ate" class="form-select" required>
                <option value="yes" {% if log and log.ate %}selected{% endif %}>Yes</option>
                <option value="no" {% if log and not log.ate %}selected{% endif %}>No</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="notes">Notes</label>
            <textarea id="notes" 
                      name="notes" 
                      class="form-textarea" 
                      placeholder="Any observations...">{{ log.notes if log and log.notes else '' }}</textarea>
        </div>

        <div class="btn-group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Add Feeding Log
            </button>
            <a href="{{ url_for('feeding_logs') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();

    // Update hidden fields from visible fields
    function updateHiddenFields() {
        const foodType = document.getElementById('food_type').value;
        const foodSize = document.getElementById('food_size').value;
        document.getElementById('food_type_hidden').value = foodType;
        document.getElementById('food_size_hidden').value = foodSize;
    }

    // Initialize hidden fields on page load
    updateHiddenFields();

    // Toggle between inventory selection and manual entry
    function toggleInventorySelection() {
        const useInventory = document.getElementById('use_inventory').value;
        const inventorySection = document.getElementById('inventory-selection');
        const manualSection = document.getElementById('manual-entry');
        const inventorySelect = document.getElementById('inventory_id');
        const foodTypeInput = document.getElementById('food_type');
        const foodSizeInput = document.getElementById('food_size');
        
        if (useInventory === 'yes') {
            inventorySection.style.display = 'block';
            manualSection.style.display = 'none';
            inventorySelect.required = true;
            foodTypeInput.required = false;
        } else {
            inventorySection.style.display = 'none';
            manualSection.style.display = 'block';
            inventorySelect.required = false;
            foodTypeInput.required = true;
            // Update hidden fields when switching back to manual
            updateHiddenFields();
        }
    }

    // Update food type and size when inventory item is selected
    document.getElementById('inventory_id').addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value) {
            const foodType = selected.getAttribute('data-food-type');
            const foodSize = selected.getAttribute('data-food-size');
            const availableQty = parseInt(selected.getAttribute('data-quantity'));
            
            // Update visible fields (for display purposes)
            document.getElementById('food_type').value = foodType;
            document.getElementById('food_size').value = foodSize || '';
            
            // Update hidden fields for form submission
            document.getElementById('food_type_hidden').value = foodType;
            document.getElementById('food_size_hidden').value = foodSize || '';
            
            // Check quantity against available stock
            checkStock();
        }
    });

    // Check if requested quantity exceeds available stock
    function checkStock() {
        const inventorySelect = document.getElementById('inventory_id');
        const quantityInput = document.getElementById('inventory_quantity');
        const stockWarning = document.getElementById('stock-warning');
        const selected = inventorySelect.options[inventorySelect.selectedIndex];
        
        if (selected.value) {
            const availableQty = parseInt(selected.getAttribute('data-quantity'));
            const requestedQty = parseInt(quantityInput.value) || 1;
            
            if (requestedQty > availableQty) {
                stockWarning.style.display = 'block';
                stockWarning.textContent = `⚠️ Only ${availableQty} available in stock`;
            } else {
                stockWarning.style.display = 'none';
            }
        }
    }

    // Add event listener for quantity changes
    document.getElementById('inventory_quantity').addEventListener('input', checkStock);
</script>
{% endblock %}